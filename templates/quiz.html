<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>중학교 과학 어휘 테스트</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <style>
        body {
            background-color: #f5f5f5;
        }
        .header {
            background-color: #fff;
            padding: 1rem;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin-bottom: 1rem;
        }
        .chat-container {
            max-width: 800px;
            margin: 2rem auto;
            background: white;
            border-radius: 10px;
            box-shadow: 0 0 10px rgba(0,0,0,0.1);
            display: flex;
            flex-direction: column;
            height: 85vh;
        }
        .chat-header {
            padding: 1rem;
            border-bottom: 1px solid #dee2e6;
            background: linear-gradient(135deg, #0d6efd, #0a58ca);
            border-radius: 10px 10px 0 0;
            text-align: center;
        }
        .chat-header h2 {
            color: white;
            margin: 0;
            font-size: 1.75rem;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .chat-header h2 i {
            margin-right: 0.5rem;
        }
        .chat-messages {
            flex-grow: 1;
            overflow-y: auto;
            padding: 1rem;
            display: flex;
            flex-direction: column;
        }
        .chat-messages::after {
            content: '';
            clear: both;
            display: table;
        }
        .chat-input-container {
            padding: 1rem;
            border-top: 1px solid #dee2e6;
            background-color: #f8f9fa;
            border-radius: 0 0 10px 10px;
        }
        .message {
            margin-bottom: 1rem;
            max-width: 80%;
            clear: both;
        }
        .user {
            float: right;
            align-self: flex-end;
        }
        .assistant {
            float: left;
            align-self: flex-start;
        }
        .message-content {
            padding: 0.75rem;
            border-radius: 15px;
            display: inline-block;
        }
        .user-message {
            background-color: #007bff;
            color: white;
        }
        .assistant-message {
            background-color: #e9ecef;
            color: #212529;
        }
        .quiz-message {
            background-color: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 15px;
            padding: 1rem;
            margin-bottom: 1rem;
        }
        .quiz-options {
            display: grid;
            gap: 0.5rem;
            margin-top: 1rem;
        }
        .option-btn {
            width: 100%;
            text-align: left;
            padding: 0.75rem;
            border: 1px solid #dee2e6;
            border-radius: 10px;
            background-color: white;
            transition: all 0.2s;
        }
        .option-btn:hover {
            background-color: #f8f9fa;
        }
        .feedback {
            margin-top: 1rem;
            padding: 0.75rem;
            border-radius: 10px;
        }
        .correct {
            background-color: #d4edda;
            color: #155724;
        }
        .incorrect {
            background-color: #f8d7da;
            color: #721c24;
        }
        .typing-indicator {
            display: flex;
            gap: 4px;
            padding: 4px 8px;
        }
        
        .typing-indicator span {
            width: 8px;
            height: 8px;
            background-color: #90949c;
            border-radius: 50%;
            animation: typing 1s infinite ease-in-out;
        }
        
        .typing-indicator span:nth-child(1) { animation-delay: 0.2s; }
        .typing-indicator span:nth-child(2) { animation-delay: 0.3s; }
        .typing-indicator span:nth-child(3) { animation-delay: 0.4s; }
        
        @keyframes typing {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-10px); }
        }
    </style>
</head>
<body>
    <div class="header">
        {% if current_user.is_authenticated %}
            <div class="container d-flex justify-content-between align-items-center">
                <span><i class="fas fa-user"></i> {{ current_user.username }}님 환영합니다!</span>
                <div>
                    <button id="reset-chat" class="btn btn-warning btn-sm me-2">대화 초기화</button>
                    <a href="{{ url_for('logout') }}" class="btn btn-outline-primary btn-sm">로그아웃</a>
                </div>
            </div>
            <div class="container mt-2">
                <div class="unit-selection-container mb-3">
                    <div class="row g-2">
                        <div class="col-md-3">
                            <select id="subject-select" class="form-select form-select-sm">
                                <option value="">모든 과목</option>
                                <option value="과학">과학</option>
                                <option value="사회">사회</option>
                                <option value="한국사">한국사</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <select id="grade-select" class="form-select form-select-sm">
                                <option value="">모든 학년</option>
                                <!-- 학년 옵션은 JavaScript로 동적 생성됩니다 -->
                            </select>
                        </div>
                        <div class="col-md-3">
                            <select id="unit-select" class="form-select form-select-sm">
                                <option value="">모든 단원</option>
                                <!-- 단원 옵션은 JavaScript로 동적 생성됩니다 -->
                            </select>
                        </div>
                        <div class="col-md-3">
                            <button id="apply-filter-btn" class="btn btn-primary btn-sm">적용</button>
                        </div>
                    </div>
                </div>
            </div>
        {% else %}
            <div class="container">
                <a href="{{ url_for('login') }}" class="btn btn-primary btn-sm">로그인</a>
            </div>
        {% endif %}
    </div>

    <div class="chat-container">
        <div class="chat-header">
            <h2><i class="fas fa-book-open"></i> 중등 교육 어휘 테스트</h2>
        </div>
        
        <div class="chat-messages" id="chat-messages">
            <!-- 메시지들이 여기에 추가됨 -->
        </div>
        
        <div class="chat-input-container">
            <div class="input-group">
                <input type="text" id="chat-input" class="form-control" placeholder="메시지를 입력하세요...">
                <button class="btn btn-primary" id="send-btn">전송</button>
            </div>
        </div>
    </div>

    <script>
        // 전역 변수 선언
        let currentThreadId = null;
        let isInitialized = false;
        const currentUser = '{{ current_user.username }}';  // 현재 사용자
        let selectedSubject = '';  // 선택된 과목
        let selectedGrade = '';    // 선택된 학년
        let selectedUnit = '';     // 선택된 단원

        // 단원 데이터 정의
        const unitData = {
            "과학": {
                "중1": [
                    "지권의 변화",
                    "여러가지 힘",
                    "생물의 다양성",
                    "기체의 성질",
                    "물질의 상태 변화",
                    "빛과 파동"
                ],
                "중2": [
                    "물질의 구성",
                    "전기와 자기",
                    "태양계",
                    "식물과 에너지",
                    "동물과 에너지",
                    "물질의 특성",
                    "수권과 해수의 순환",
                    "열과 우리 생활",
                    "재해, 재난과 안전"
                ],
                "중3": [
                    "화학반응의 규칙과 에너지 변화",
                    "기권과 날씨",
                    "운동과 에너지",
                    "자극과 반응",
                    "생식과 유전",
                    "에너지 전환과 보존",
                    "별과 우주"
                ]
            },
            "사회": {
                "초4": [
                    "지역의 위치와 특성",
                    "우리가 알아보는 지역의 역사",
                    "지역의 공공기관과 주민 참여",
                    "촌락과 도시의 생활 모습",
                    "필요한 것의 생산과 교환",
                    "사회 변화와 문화의 다양성"
                ],
                "초5": [
                    "국토의 위치와 영역",
                    "국토의 자연환경",
                    "국토의 인문환경",
                    "인권을 존중하는 삶",
                    "법의 의미와 역할",
                    "헌법과 인권 보장"
                ],
                "초6": [
                    "우리나라의 정치 발전",
                    "일상생활과 민주주의",
                    "민주정치의 원리와 국가기관의 역할",
                    "경제주체의 역할과 우리나라 경제체제의 특징",
                    "경제생활의 변화와 우리나라 경제의 성장",
                    "세계 속의 우리나라 경제",
                    "지구, 대륙 그리고 국가들",
                    "세계의 다양한 삶의 모습",
                    "우리나라와 가까운 나라들",
                    "한반도의 미래와 통일",
                    "지구촌의 평화와 발전"
                ],
                "중3": [
                    "인권과 기본권",
                    "인권 침해와 인권 구제 기관",
                    "근로자의 권리와 보호",
                    "국회의 지위와 권한",
                    "행정부와 대통령",
                    "법원과 헌법 재판소",
                    "경제 활동과 희소성",
                    "기회 비용과 합리적 선택",
                    "경제 문제와 경제 체제",
                    "기업의 역할과 책임",
                    "지속 가능한 경제 생활",
                    "시장의 의미와 종류",
                    "수요와 공급, 시장 가격의 결정",
                    "수요와 공급의 변동",
                    "국내 총생산과 경제 성장",
                    "물가와 인플레이션",
                    "실업과 고용안정",
                    "국제 거래의 이해",
                    "환율의 이해",
                    "국제 사회의 의미와 특징",
                    "국제 사회의 행위 주체",
                    "우리나라 주변국과의 관계와 공존 노력"
                ]
            },
            "한국사": {
                "초5": [
                    "조선의 건국",
                    "조선의 도읍, 한양",
                    "조선의 여러 제도",
                    "세종 대에 이룬 문화 발전",
                    "훈민정음",
                    "조선 전기의 사회 모습",
                    "임진왜란",
                    "병자호란",
                    "영조의 탕평 정치",
                    "정조의 개혁 정치",
                    "정약용이 꿈꾸었던 사회",
                    "조선후기 서민 문화",
                    "흥선대원군의 정책",
                    "조선의 개항 과정",
                    "개화기 조선",
                    "고조선의 등장",
                    "건국 이야기",
                    "삼국의 성립",
                    "삼국의 발전",
                    "신라의 삼국 통일",
                    "발해의 건국",
                    "삼국의 문화",
                    "삼국의 불교 문화1",
                    "삼국의 불교 문화2",
                    "고려의 건국",
                    "고려의 후삼국 통일",
                    "거란의 침입과 극복 과정",
                    "몽골의 침입과 극복",
                    "고려 사회의 변화",
                    "고려의 문화"
                ],
                "초6": [
                    "대한제국과 독립 협회",
                    "일제의 침략",
                    "일제의 식민 통치",
                    "3.1운동과 대한민국 임시 정부",
                    "3.1운동 이후 독립 운동",
                    "일제에 맞서 민족을 지키기 위한 노력1",
                    "일제에 맞서 민족을 지키기 위한 노력2",
                    "8.15 광복",
                    "대한민국 정부 수립의 의미",
                    "민족의 상처, 6.25전쟁의 전개 과정",
                    "6.25전쟁의 결과",
                    "민주주의의 시련과 발전",
                    "경제 성장과 사회,문화의 변화",
                    "대한민국의 미래와 평화 통일"
                ],
                "중1": [
                    "만주와 한반도의 선사 문화",
                    "청동기 문화의 보급과 고조선의 발전",
                    "철기 문화의 발전과 여러 나라의 성장",
                    "고구려의 성장과 발전",
                    "백제의 성립과 대외 활동",
                    "신라의 성장과 발전",
                    "가야 연맹의 성장",
                    "고분과 생활 모습",
                    "삼국과 가야의 대외 교류",
                    "고구려와 수, 당의 전쟁",
                    "삼국 통일과 발해의 건국",
                    "통일 신라의 발전과 체제 정비",
                    "발해의 발전",
                    "신라 사회의 동요와 후삼국의 성립",
                    "신라와 발해의 문화",
                    "신라와 발해의 대외 교류"
                ],
                "중2": [
                    "고려의 건국과 국가 기틀의 확립",
                    "고려의 통치 체제 정비",
                    "문벌 사회의 동요와 무신 정권의 수립",
                    "고려의 대외 관계",
                    "몽골의 침략과 저항",
                    "원의 간섭과 권문세족의 성장",
                    "공민왕의 개혁 정치",
                    "고려 사회의 모습",
                    "다양한 문화의 발달",
                    "조선의 건국과 국가 기틀의 확립",
                    "조선의 통치 체제 정비",
                    "대외 관계와 외교 정책",
                    "사림의 성장과 붕당의 형성",
                    "유교 윤리의 보급",
                    "훈민정음 창제와 과학 기술 발달",
                    "왜란의 발발과 극복",
                    "호란의 발발과 영향"
                ],
                "중3": [
                    "양난 이후 통치 체제 정비",
                    "조선 후기 정치 운영의 변화",
                    "조선 후기 경제와 신분제의 동요",
                    "삼정의 문란과 농민 봉기",
                    "동아시아 문화 교류와 서학의 전래",
                    "새로운 학문과 예술의 경향",
                    "조선 후기 생활 모습의 변화",
                    "서민 문화의 발달",
                    "문호 개방과 근대적 개혁의 추진",
                    "일본의 침략과 국권 수호 운동의 전개",
                    "독립을 위한 노력과 대한민국 정부 수립",
                    "개항과 식민지 경제",
                    "대한민국의 경제 성장",
                    "제헌 헌법 공포와 이승만 정부",
                    "4.19 혁명의 전개와 유신 체제 성립"
                ]
            }
        };

        // 과목별 사용 가능한 학년 정의
        const subjectGrades = {
            "과학": ["중1", "중2", "중3"],
            "사회": ["초4", "초5", "초6", "중3"],
            "한국사": ["초5", "초6", "중1", "중2", "중3"]
        };

        // 로그아웃 전 데이터 저장을 위한 이벤트 리스너
        window.addEventListener('beforeunload', () => {
            if (currentUser) {
                const messagesContainer = document.getElementById('chat-messages');
                if (messagesContainer && messagesContainer.innerHTML) {
                    localStorage.setItem(`chatMessages_${currentUser}`, messagesContainer.innerHTML);
                    if (chatManager.threadId) {
                        localStorage.setItem(`threadId_${currentUser}`, chatManager.threadId);
                    }
                }
            }
        });

        // 채팅 관리자 객체
        const chatManager = {
            // thread_id를 클래스 속성으로 추가
            threadId: null,

            async init() {
                // 사용자별 저장된 메시지 불러오기
                const savedMessages = localStorage.getItem(`chatMessages_${currentUser}`);
                const savedThreadId = localStorage.getItem(`threadId_${currentUser}`);
                
                if (savedMessages && savedThreadId && currentUser) {
                    const messagesContainer = document.getElementById('chat-messages');
                    messagesContainer.innerHTML = savedMessages;
                    this.threadId = savedThreadId;
                    isInitialized = true;
                    
                    // 스크롤을 최하단으로 이동
                    requestAnimationFrame(() => {
                        messagesContainer.scrollTop = messagesContainer.scrollHeight;
                    });
                } else if (!currentUser) {
                    // 로그인하지 않은 경우 마지막 사용자의 대화 내용 표시
                    const lastUser = localStorage.getItem('lastUser');
                    const lastMessages = localStorage.getItem(`chatMessages_${lastUser}`);
                    const lastThreadId = localStorage.getItem(`threadId_${lastUser}`);
                    
                    if (lastMessages && lastThreadId) {
                        const messagesContainer = document.getElementById('chat-messages');
                        messagesContainer.innerHTML = lastMessages;
                        this.threadId = lastThreadId;
                        isInitialized = true;
                        
                        requestAnimationFrame(() => {
                            messagesContainer.scrollTop = messagesContainer.scrollHeight;
                        });
                    } else {
                        this.initializeNewChat();
                    }
                } else {
                    this.initializeNewChat();
                }
            },

            initializeNewChat() {
                this.appendMessage('안녕하세요! 초중 교육 학습 도우미입니다.', 'text', 'assistant');
                
                const messagesContainer = document.getElementById('chat-messages');
                const buttonDiv = document.createElement('div');
                buttonDiv.className = 'message assistant';
                buttonDiv.innerHTML = `
                    <div class="message-content">
                        <button class="btn btn-primary me-2" onclick="chatManager.startQuiz('1문제 출제')">1문제 출제</button>
                        <button class="btn btn-primary me-2" onclick="chatManager.startQuiz('5문제 출제')">5문제 출제</button>
                        <button class="btn btn-primary me-2" onclick="chatManager.startQuiz('10문제 출제')">10문제 출제</button>
                        <button class="btn btn-secondary" onclick="chatManager.endQuiz()">나중에 하기</button>
                    </div>
                `;
                messagesContainer.appendChild(buttonDiv);
                isInitialized = true;
                
                // 초기 상태 저장
                this.saveMessages();
            },

            // 메시지 저장 함수 수정
            saveMessages() {
                try {
                    const messagesContainer = document.getElementById('chat-messages');
                    if (messagesContainer && messagesContainer.innerHTML && currentUser) {
                        localStorage.setItem(`chatMessages_${currentUser}`, messagesContainer.innerHTML);
                        if (this.threadId) {
                            localStorage.setItem(`threadId_${currentUser}`, this.threadId);
                        }
                        // 마지막 사용자 정보 저장
                        localStorage.setItem('lastUser', currentUser);
                    }
                } catch (error) {
                    console.error('Error saving messages:', error);
                }
            },

            // 대화 초기화 함수 수정
            resetChat() {
                try {
                    if (currentUser) {
                        localStorage.removeItem(`chatMessages_${currentUser}`);
                        localStorage.removeItem(`threadId_${currentUser}`);
                    }
                    const messagesContainer = document.getElementById('chat-messages');
                    messagesContainer.innerHTML = '';
                    this.threadId = null;
                    this.initializeNewChat();
                } catch (error) {
                    console.error('Error resetting chat:', error);
                    alert('대화 초기화 중 오류가 발생했습니다.');
                }
            },

            async startQuiz(buttonText = '테스트 시작') {
                try {
                    this.appendMessage(buttonText, 'text', 'user');
                    
                    // 문제 출제 버튼만 비활성화하고 단원 선택 컨트롤은 비활성화하지 않음
                    const quizButtons = document.querySelectorAll('.message.assistant .message-content .btn-primary, .message.assistant .message-content .btn-secondary');
                    quizButtons.forEach(btn => {
                        btn.disabled = true;
                    });
                    
                    // 단원 선택 컨트롤은 활성 상태 유지
                    const subjectSelect = document.getElementById('subject-select');
                    const gradeSelect = document.getElementById('grade-select');
                    const unitSelect = document.getElementById('unit-select');
                    const applyFilterBtn = document.getElementById('apply-filter-btn');
                    
                    if (subjectSelect) subjectSelect.disabled = false;
                    if (gradeSelect) gradeSelect.disabled = false;
                    if (unitSelect) unitSelect.disabled = false;
                    if (applyFilterBtn) applyFilterBtn.disabled = false;
                    
                    const loadingId = this.appendLoadingMessage();

                    // thread_id가 없는 경우 새로운 thread 생성
                    if (!this.threadId) {
                        const threadResponse = await fetch('/api/quiz/new', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({
                                message: 'init'
                            })
                        });
                        const threadData = await threadResponse.json();
                        if (threadData.thread_id) {
                            this.threadId = threadData.thread_id;
                        }
                    }

                    // 단원 필터 추가
                    const requestData = {
                        thread_id: this.threadId,
                        message: buttonText
                    };

                    // 선택된 과목, 학년, 단원이 있으면 추가
                    if (selectedSubject) {
                        requestData.subject = selectedSubject;
                    }
                    if (selectedGrade) {
                        requestData.grade = selectedGrade;
                    }
                    if (selectedUnit) {
                        requestData.unit = selectedUnit;
                    }

                    console.log('요청 데이터:', requestData); // 디버깅용 로그 추가

                    const response = await fetch('/api/chat', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(requestData)
                    });
                    
                    const data = await response.json();
                    console.log('서버 응답:', data);
                    
                    this.removeMessage(loadingId);
                    
                    // 문제 출제 버튼 다시 활성화
                    quizButtons.forEach(btn => {
                        btn.disabled = false;
                    });
                    
                    if (data.error) {
                        this.appendMessage('퀴즈를 불러오는 중 오류가 발생했습니다.', 'text', 'assistant');
                        return;
                    }
                    
                    if (data.type === 'QUIZ') {
                        const messagesContainer = document.getElementById('chat-messages');
                        const quizDiv = document.createElement('div');
                        quizDiv.className = 'message assistant';
                        
                        // 현재 문제와 총 문제 수 설정
                        const currentQuestion = data.progress ? data.progress.current : 1;
                        const totalQuestions = data.progress ? data.progress.total : 1;
                        const quiz = data.quiz || (data.questions && data.questions[0]);
                        
                        if (!quiz) {
                            console.error('퀴즈 데이터 형식 오류:', data);
                            this.appendMessage('퀴즈 데이터 형식이 올바르지 않습니다.', 'text', 'assistant');
                            return;
                        }
                        
                        let quizHTML = '<div class="quiz-message">';
                        quizHTML += `
                            <div class="mb-4 p-3" style="border: 1px solid #dee2e6; border-radius: 10px;">
                                <div class="badge bg-secondary mb-2">${currentQuestion}/${totalQuestions}번 문제</div>
                                <div class="badge bg-primary ms-2">${quiz.subject || '과학'}</div>
                                <div class="badge bg-info ms-2">${quiz.grade || ''}</div>
                                <div class="badge bg-warning ms-2">${quiz.unit || ''}</div>
                                <div class="mt-2 mb-3">${quiz.question}</div>
                                <div class="quiz-options" style="display: grid; gap: 0.3rem; margin-top: 0.5rem;">
                                    ${quiz.options.map((option, optionIndex) => `
                                        <div class="option-item" 
                                             style="cursor: pointer; padding: 8px; margin: 2px 0; border: 1px solid #dee2e6; border-radius: 8px; background-color: white; transition: all 0.2s;"
                                             onmouseover="this.style.backgroundColor='#e9ecef'; this.style.boxShadow='0 2px 4px rgba(0,0,0,0.1)'"
                                             onmouseout="this.style.backgroundColor='white'; this.style.boxShadow='none'"
                                             onclick="chatManager.submitAnswer(${currentQuestion}, '${option}')">
                                            ${option}
                                        </div>
                                    `).join('')}
                                </div>
                            </div>
                        `;
                        
                        quizHTML += `</div>`;
                        
                        quizDiv.innerHTML = quizHTML;
                        messagesContainer.appendChild(quizDiv);
                        messagesContainer.scrollTop = messagesContainer.scrollHeight;
                    }
                } catch (error) {
                    console.error('Error starting quiz:', error);
                    this.appendMessage('퀴즈를 시작하는 중 오류가 발생했습니다.', 'text', 'assistant');
                    
                    // 오류 발생 시에도 버튼과 단원 선택 컨트롤 활성화
                    const quizButtons = document.querySelectorAll('.message.assistant .message-content .btn-primary, .message.assistant .message-content .btn-secondary');
                    quizButtons.forEach(btn => {
                        btn.disabled = false;
                    });
                    
                    const subjectSelect = document.getElementById('subject-select');
                    const gradeSelect = document.getElementById('grade-select');
                    const unitSelect = document.getElementById('unit-select');
                    const applyFilterBtn = document.getElementById('apply-filter-btn');
                    
                    if (subjectSelect) subjectSelect.disabled = false;
                    if (gradeSelect) gradeSelect.disabled = false;
                    if (unitSelect) unitSelect.disabled = false;
                    if (applyFilterBtn) applyFilterBtn.disabled = false;
                }
            },

            async submitAnswer(questionNumber, selectedAnswer) {
                try {
                    // 사용자 답변을 UI에 표시
                    this.appendMessage(selectedAnswer, 'text', 'user');
                    const loadingId = this.appendLoadingMessage();

                    const response = await fetch('/api/chat', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            thread_id: this.threadId,
                            message: selectedAnswer,
                            is_quiz_answer: true  // 퀴즈 답변임을 표시
                        })
                    });

                    this.removeMessage(loadingId);
                    
                    const data = await response.json();
                    
                    if (data.type === 'ANSWER') {
                        const resultHTML = `
                            <div class="message assistant">
                                <div class="message-content">
                                    <div class="alert ${data.answer.correct ? 'alert-success' : 'alert-danger'} mb-2">
                                        ${data.answer.correct ? '정답입니다! 👏' : '아쉽네요, 오답입니다. 😢'}
                                    </div>
                                    <div class="mt-2">${data.answer.explanation}</div>
                                </div>
                            </div>
                        `;
                        
                        document.getElementById('chat-messages').insertAdjacentHTML('beforeend', resultHTML);
                        
                        // 다음 문제가 있는 경우
                        if (data.next_question) {
                            setTimeout(() => {
                                const quizDiv = document.createElement('div');
                                quizDiv.className = 'message assistant';
                                
                                let quizHTML = '<div class="quiz-message">';
                                quizHTML += `
                                    <div class="mb-4 p-3" style="border: 1px solid #dee2e6; border-radius: 10px;">
                                        <div class="badge bg-secondary mb-2">${data.next_question.progress.current}/${data.next_question.progress.total}번 문제</div>
                                        <div class="badge bg-primary ms-2">${data.next_question.quiz.subject || '과학'}</div>
                                        <div class="badge bg-info ms-2">${data.next_question.quiz.grade || ''}</div>
                                        <div class="badge bg-warning ms-2">${data.next_question.quiz.unit || ''}</div>
                                        <div class="mt-2 mb-3">${data.next_question.quiz.question}</div>
                                        <div class="quiz-options" style="display: grid; gap: 0.3rem; margin-top: 0.5rem;">
                                            ${data.next_question.quiz.options.map((option, optionIndex) => `
                                                <div class="option-item" 
                                                     style="cursor: pointer; padding: 8px; margin: 2px 0; border: 1px solid #dee2e6; border-radius: 8px; background-color: white; transition: all 0.2s;"
                                                     onmouseover="this.style.backgroundColor='#e9ecef'; this.style.boxShadow='0 2px 4px rgba(0,0,0,0.1)'"
                                                     onmouseout="this.style.backgroundColor='white'; this.style.boxShadow='none'"
                                                     onclick="chatManager.submitAnswer(${data.next_question.progress.current}, '${option}')">
                                                    ${option}
                                                </div>
                                            `).join('')}
                                        </div>
                                    </div>
                                </div>`;
                                
                                quizDiv.innerHTML = quizHTML;
                                document.getElementById('chat-messages').appendChild(quizDiv);
                                document.getElementById('chat-messages').scrollTop = document.getElementById('chat-messages').scrollHeight;
                                
                                // 단원 선택 컨트롤 활성화 상태 유지
                                const subjectSelect = document.getElementById('subject-select');
                                const gradeSelect = document.getElementById('grade-select');
                                const unitSelect = document.getElementById('unit-select');
                                const applyFilterBtn = document.getElementById('apply-filter-btn');
                                
                                if (subjectSelect) subjectSelect.disabled = false;
                                if (gradeSelect) gradeSelect.disabled = false;
                                if (unitSelect) unitSelect.disabled = false;
                                if (applyFilterBtn) applyFilterBtn.disabled = false;
                            }, 1000);
                        } else {
                            // 모든 문제가 완료된 경우
                            setTimeout(() => {
                                const completionDiv = document.createElement('div');
                                completionDiv.className = 'message assistant';
                                completionDiv.innerHTML = `
                                    <div class="message-content">
                                        <div class="alert alert-info">
                                            모든 문제가 완료되었습니다! 🎉
                                        </div>
                                        <div class="text-center mt-3">
                                            <button class="btn btn-primary me-2" onclick="chatManager.startQuiz('1문제 출제')">1문제 출제</button>
                                            <button class="btn btn-primary me-2" onclick="chatManager.startQuiz('5문제 출제')">5문제 출제</button>
                                            <button class="btn btn-primary me-2" onclick="chatManager.startQuiz('10문제 출제')">10문제 출제</button>
                                            <button class="btn btn-secondary" onclick="chatManager.endQuiz()">종료</button>
                                        </div>
                                    </div>
                                `;
                                document.getElementById('chat-messages').appendChild(completionDiv);
                                document.getElementById('chat-messages').scrollTop = document.getElementById('chat-messages').scrollHeight;
                                
                                // 단원 선택 컨트롤 활성화 상태 유지
                                const subjectSelect = document.getElementById('subject-select');
                                const gradeSelect = document.getElementById('grade-select');
                                const unitSelect = document.getElementById('unit-select');
                                const applyFilterBtn = document.getElementById('apply-filter-btn');
                                
                                if (subjectSelect) subjectSelect.disabled = false;
                                if (gradeSelect) gradeSelect.disabled = false;
                                if (unitSelect) unitSelect.disabled = false;
                                if (applyFilterBtn) applyFilterBtn.disabled = false;
                            }, 1000);
                        }
                        
                        document.getElementById('chat-messages').scrollTop = document.getElementById('chat-messages').scrollHeight;
                    }
                } catch (error) {
                    console.error('Error submitting answer:', error);
                    this.appendMessage('답안 제출 중 오류가 발생했습니다.', 'text', 'assistant');
                    
                    // 오류 발생 시에도 단원 선택 컨트롤 활성화 상태 유지
                    const subjectSelect = document.getElementById('subject-select');
                    const gradeSelect = document.getElementById('grade-select');
                    const unitSelect = document.getElementById('unit-select');
                    const applyFilterBtn = document.getElementById('apply-filter-btn');
                    
                    if (subjectSelect) subjectSelect.disabled = false;
                    if (gradeSelect) gradeSelect.disabled = false;
                    if (unitSelect) unitSelect.disabled = false;
                    if (applyFilterBtn) applyFilterBtn.disabled = false;
                }
            },

            endQuiz() {
                this.appendMessage("종료", 'text', 'user');
                this.appendMessage('알겠습니다. 준비되면 "테스트 시작"이라고 입력해주세요.', 'text', 'assistant');
            },

            async sendMessage() {
                const input = document.getElementById('chat-input');
                const message = input.value.trim();
                
                if (!message) return;
                
                // 문제 출제 요청 패턴 확인
                const quizRequestPattern = /(\d+)문제\s*(출제|내줘|주세요|풀고싶어요|풀래요|풀어볼래요)/;
                const match = message.match(quizRequestPattern);
                
                input.disabled = true;
                document.getElementById('send-btn').disabled = true;
                
                if (match) {
                    // 문제 출제 요청인 경우 startQuiz 메서드 호출
                    const questionCount = match[1];
                    await this.startQuiz(`${questionCount}문제 출제`);
                } else {
                    this.appendMessage(message, 'text', 'user');
                    input.value = '';

                    const loadingId = this.appendLoadingMessage();

                    try {
                        // thread_id가 없는 경우 새로운 thread 생성
                        if (!this.threadId) {
                            const threadResponse = await fetch('/api/quiz/new', {
                                method: 'POST',
                                headers: {
                                    'Content-Type': 'application/json'
                                },
                                body: JSON.stringify({
                                    message: 'init'
                                })
                            });
                            const threadData = await threadResponse.json();
                            if (threadData.thread_id) {
                                this.threadId = threadData.thread_id;
                            }
                        }

                        // 일반 질문인 경우
                        const response = await fetch('/api/chat', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({
                                thread_id: this.threadId,
                                message: message
                            })
                        });
                        
                        this.removeMessage(loadingId);
                        
                        const data = await response.json();
                        
                        // 응답 타입에 따른 처리
                        if (data.type === "CHAT") {
                            this.appendMessage(data.message, 'text', 'assistant');
                        } else if (data.type === "ANSWER") {
                            this.appendMessage(data.answer.explanation, 'text', 'assistant');
                        } else if (data.type === "QUIZ") {
                            if (data.questions && data.questions.length > 0) {
                                const firstQuestion = data.questions[0];
                                this.appendMessage(firstQuestion, 'quiz', 'assistant', {
                                    current: 1,
                                    total: data.questions.length
                                });
                                this.currentQuestions = data.questions;
                                if (data.thread_id) {
                                    this.threadId = data.thread_id;
                                }
                            } else if (data.quiz) {
                                this.appendMessage(data.quiz, 'quiz', 'assistant', data.progress);
                                if (data.thread_id) {
                                    this.threadId = data.thread_id;
                                }
                            }
                        } else if (data.type === "ERROR") {
                            this.appendMessage(data.message, 'text', 'assistant');
                        }
                        
                    } catch (error) {
                        console.error('Error:', error);
                        this.removeMessage(loadingId);
                        this.appendMessage('죄송합니다. 메시지 전송 중 오류가 발생했습니다.', 'text', 'assistant');
                    }
                }
                
                input.disabled = false;
                document.getElementById('send-btn').disabled = false;
                input.value = '';
                input.focus();
            },

            appendMessage(content, type = 'text', sender = 'assistant', progress = null) {
                const messagesContainer = document.getElementById('chat-messages');
                const messageDiv = document.createElement('div');
                messageDiv.className = `message ${sender}`;
                
                if (type === 'quiz' && content) {
                    // 현재 문제와 총 문제 수 설정
                    const currentQuestion = progress ? progress.current : 1;
                    const totalQuestions = progress ? progress.total : 1;
                    
                    messageDiv.innerHTML = `
                        <div class="quiz-message">
                            <div class="mb-4 p-3" style="border: 1px solid #dee2e6; border-radius: 10px;">
                                <div class="badge bg-secondary mb-2">${currentQuestion}/${totalQuestions}번 문제</div>
                                <div class="badge bg-primary ms-2">${content.subject || '과학'}</div>
                                <div class="badge bg-info ms-2">${content.grade || ''}</div>
                                <div class="badge bg-warning ms-2">${content.unit || ''}</div>
                                <div class="mt-2 mb-3">${content.question}</div>
                                <div class="quiz-options" style="display: grid; gap: 0.3rem; margin-top: 0.5rem;">
                                    ${content.options.map((option, optionIndex) => `
                                        <div class="option-item" 
                                             style="cursor: pointer; padding: 8px; margin: 2px 0; border: 1px solid #dee2e6; border-radius: 8px; background-color: white; transition: all 0.2s;"
                                             onmouseover="this.style.backgroundColor='#e9ecef'; this.style.boxShadow='0 2px 4px rgba(0,0,0,0.1)'"
                                             onmouseout="this.style.backgroundColor='white'; this.style.boxShadow='none'"
                                             onclick="chatManager.submitAnswer(${currentQuestion}, '${option}')">
                                            ${option}
                                        </div>
                                    `).join('')}
                                </div>
                            </div>
                        </div>
                    `;
                } else {
                    if (typeof content === 'string' && content.trim().startsWith('{')) {
                        try {
                            const jsonObj = JSON.parse(content);
                            content = JSON.stringify(jsonObj, null, 2);
                            messageDiv.innerHTML = `
                                <div class="message-content ${sender}-message">
                                    <pre style="margin: 0; white-space: pre-wrap;">${content}</pre>
                                </div>
                            `;
                        } catch (e) {
                            messageDiv.innerHTML = `
                                <div class="message-content ${sender}-message">
                                    ${content}
                                </div>
                            `;
                        }
                    } else {
                        messageDiv.innerHTML = `
                            <div class="message-content ${sender}-message">
                                ${content}
                            </div>
                        `;
                    }
                }
                
                messagesContainer.appendChild(messageDiv);
                
                // 스크롤을 최하단으로 이동 (requestAnimationFrame 사용)
                requestAnimationFrame(() => {
                    messagesContainer.scrollTop = messagesContainer.scrollHeight;
                });
                
                this.saveMessages();
            },

            appendLoadingMessage() {
                const messagesContainer = document.getElementById('chat-messages');
                const loadingDiv = document.createElement('div');
                const loadingId = 'loading-' + Date.now();
                loadingDiv.id = loadingId;
                loadingDiv.className = 'message assistant';
                loadingDiv.innerHTML = `
                    <div class="message-content assistant-message">
                        <div class="typing-indicator">
                            <span></span>
                            <span></span>
                            <span></span>
                        </div>
                    </div>
                `;
                messagesContainer.appendChild(loadingDiv);
                messagesContainer.scrollTop = messagesContainer.scrollHeight;
                return loadingId;
            },

            removeMessage(messageId) {
                const messageDiv = document.getElementById(messageId);
                if (messageDiv) {
                    messageDiv.remove();
                }
            }
        };

        document.addEventListener('DOMContentLoaded', () => {
            chatManager.init();
            
            document.getElementById('send-btn').addEventListener('click', () => {
                chatManager.sendMessage.call(chatManager);
            });
            
            document.getElementById('chat-input').addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    chatManager.sendMessage.call(chatManager);
                }
            });

            // 초기화 버튼 이벤트 리스너 추가
            document.getElementById('reset-chat').addEventListener('click', () => {
                if (confirm('모든 대화 내용이 삭제됩니다. 계속하시겠습니까?')) {
                    chatManager.resetChat();
                    
                    // 단원 선택 초기화
                    const subjectSelect = document.getElementById('subject-select');
                    const gradeSelect = document.getElementById('grade-select');
                    const unitSelect = document.getElementById('unit-select');
                    if (subjectSelect) subjectSelect.value = '';
                    if (gradeSelect) gradeSelect.value = '';
                    if (unitSelect) unitSelect.value = '';
                    selectedSubject = '';
                    selectedGrade = '';
                    selectedUnit = '';
                }
            });

            // 과목 선택 시 해당 과목에 맞는 학년만 표시
            const subjectSelect = document.getElementById('subject-select');
            if (subjectSelect) {
                subjectSelect.addEventListener('change', function() {
                    const selectedSubject = this.value;
                    const gradeSelect = document.getElementById('grade-select');
                    const unitSelect = document.getElementById('unit-select');
                    
                    // 학년 옵션 초기화
                    gradeSelect.innerHTML = '<option value="">모든 학년</option>';
                    
                    // 단원 옵션 초기화
                    unitSelect.innerHTML = '<option value="">모든 단원</option>';
                    
                    if (selectedSubject) {
                        // 선택된 과목에 해당하는 학년만 추가
                        const availableGrades = subjectGrades[selectedSubject] || [];
                        availableGrades.forEach(grade => {
                            const option = document.createElement('option');
                            option.value = grade;
                            option.textContent = grade;
                            gradeSelect.appendChild(option);
                        });
                    } else {
                        // 과목이 선택되지 않은 경우 모든 학년 표시
                        const allGrades = ["중1", "중2", "중3"];
                        allGrades.forEach(grade => {
                            const option = document.createElement('option');
                            option.value = grade;
                            option.textContent = grade;
                            gradeSelect.appendChild(option);
                        });
                    }
                });
                
                // 페이지 로드 시 과목 선택 이벤트 트리거하여 학년 목록 초기화
                const event = new Event('change');
                subjectSelect.dispatchEvent(event);
            }

            // 학년 선택 시 해당 과목과 학년에 맞는 단원만 표시
            const gradeSelect = document.getElementById('grade-select');
            if (gradeSelect) {
                gradeSelect.addEventListener('change', function() {
                    const selectedSubject = document.getElementById('subject-select').value;
                    const selectedGrade = this.value;
                    const unitSelect = document.getElementById('unit-select');
                    
                    // 단원 옵션 초기화
                    unitSelect.innerHTML = '<option value="">모든 단원</option>';
                    
                    if (selectedSubject && selectedGrade && unitData[selectedSubject] && unitData[selectedSubject][selectedGrade]) {
                        // 선택된 과목과 학년에 해당하는 단원만 추가
                        unitData[selectedSubject][selectedGrade].forEach(unit => {
                            const option = document.createElement('option');
                            option.value = unit;
                            option.textContent = unit;
                            unitSelect.appendChild(option);
                        });
                    }
                });
            }

            // 단원 필터 적용 버튼 이벤트 리스너
            const applyFilterBtn = document.getElementById('apply-filter-btn');
            if (applyFilterBtn) {
                applyFilterBtn.addEventListener('click', function() {
                    const subjectSelect = document.getElementById('subject-select');
                    const gradeSelect = document.getElementById('grade-select');
                    const unitSelect = document.getElementById('unit-select');
                    
                    selectedSubject = subjectSelect.value;
                    selectedGrade = gradeSelect.value;
                    selectedUnit = unitSelect.value;
                    
                    let message = '';
                    if (selectedSubject && selectedGrade && selectedUnit) {
                        message = `${selectedSubject} ${selectedGrade} ${selectedUnit} 단원의 문제를 출제합니다.`;
                    } else if (selectedSubject && selectedGrade) {
                        message = `${selectedSubject} ${selectedGrade} 학년의 문제를 출제합니다.`;
                    } else if (selectedSubject) {
                        message = `${selectedSubject} 과목의 문제를 출제합니다.`;
                    } else {
                        message = '모든 과목의 문제를 출제합니다.';
                    }
                    
                    console.log('필터 적용됨:', selectedSubject, selectedGrade, selectedUnit); // 디버깅용 로그 추가
                    
                    // 메시지와 버튼을 함께 추가
                    const messagesContainer = document.getElementById('chat-messages');
                    const messageDiv = document.createElement('div');
                    messageDiv.className = 'message assistant';
                    messageDiv.innerHTML = `
                        <div class="message-content assistant-message">
                            ${message}
                        </div>
                    `;
                    messagesContainer.appendChild(messageDiv);
                    
                    // 버튼 추가
                    const buttonDiv = document.createElement('div');
                    buttonDiv.className = 'message assistant';
                    buttonDiv.innerHTML = `
                        <div class="message-content">
                            <button class="btn btn-primary me-2" onclick="chatManager.startQuiz('1문제 출제')">1문제 출제</button>
                            <button class="btn btn-primary me-2" onclick="chatManager.startQuiz('5문제 출제')">5문제 출제</button>
                            <button class="btn btn-primary me-2" onclick="chatManager.startQuiz('10문제 출제')">10문제 출제</button>
                            <button class="btn btn-secondary" onclick="chatManager.endQuiz()">나중에 하기</button>
                        </div>
                    `;
                    messagesContainer.appendChild(buttonDiv);
                    
                    // 스크롤을 최하단으로 이동
                    requestAnimationFrame(() => {
                        messagesContainer.scrollTop = messagesContainer.scrollHeight;
                    });
                    
                    // 메시지 저장
                    chatManager.saveMessages();
                });
            }
        });
    </script>
</body>
</html> 